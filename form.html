<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Mikro-Interventionen f√ºr eine geschlechtergerechte Stadt</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
    <body>
<!-- Navbar placeholder -->
  <div id="nav-placeholder"></div>

        <div class="container">
            <h1 class="mt-5">Add Data</h1>
            <p>Fill this form in to add data</p>
        </div>

    <div class="container mt-10">
        <!-- Dynamic Form -->
  <div class="col-md-9" id="form_section">
    <h6>Add/Edit Data</h6>
    <form id="my_form">
      <div id="form_fields">
        <!-- Datenschutzhinweis -->
        <div class="mb-3">
          <label for="datenschutzhinweis" class="form-label">Datenschutzhinweis</label>
          <select class="form-select" id="datenschutzhinweis" name="datenschutzhinweis">
            <option value="">-- Select --</option>
            <option value="ja">Ja</option>
            <option value="nein">Nein</option>
          </select>
        </div>

        <!-- Art der Mikrointervention -->
        <div class="mb-3">
          <label for="art_intervention" class="form-label">Art der Mikrointervention</label>
          <input class="form-control" id="art_intervention" name="art_intervention">
        </div>

        <!-- Standort -->
        <div class="mb-3">
          <label for="standort" class="form-label">Standort</label>
          <input type="text" class="form-control" id="standort" name="standort" placeholder="Enter location" required>
        </div>

        <!-- Latitude and Longitude -->
        <div class="row">
        <div id="map" style="height:500px; display: none;"></div>
        </div>
        <div class="row" style="padding-top: 20px;">
          <div class="col-md-6">
            <button id="findCoordinatesBtn" class="btn btn-secondary">Find coordinates on map</button>
          </div>
          <div class="col-md-6">
             <!-- GPS Standort Button -->
            <button id="getLocationBtn" class="btn btn-primary gps-button">
                üìç Ihre aktuelle Standort erfassen
            </button>
            <div id="gpsStatus" style="display:none;"></div>
          <p class="mb-4"><i>Bitte erlaube zuerst den Standortzugriff.</i></p>
          </div>
        </div>
        <div class="row" style="padding-top: 15px;">          
            <div class="col-md-6">
            <div class="mb-3">
              <label for="latitude" class="form-label">Latitude</label>
              <input type="number" step="0.000001" class="form-control" id="latitude" name="latitude" placeholder="e.g., 47.8136" required>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label for="longitude" class="form-label">Longitude</label>
              <input type="number" step="0.000001" class="form-control" id="longitude" name="longitude" placeholder="e.g., 13.0550" required>
            </div>
          </div>
        </div>

        <!-- Ortstyp -->
        <div class="mb-3">
          <label for="ortstyp" class="form-label">Ortstyp</label>
          <select class="form-select" id="ortstyp" name="ortstyp" required>
            <option value="">-- Select --</option>
            <option value="school">School</option>
            <option value="street">Street</option>
            <option value="building">Building</option>
          </select>
        </div>

        <!-- Kurze Beschreibung -->
        <div class="mb-3">
          <label for="kurze_beschreibung" class="form-label">Kurze Beschreibung</label>
          <textarea class="form-control" id="kurze_beschreibung" name="beschreibung" rows="3" placeholder="Enter brief description" required></textarea>
        </div>

        <!-- Beteiligung der Person -->
        <div class="mb-3">
          <label for="beteiligung_person" class="form-label">Beteiligung der Person</label>
          <input type="text" class="form-control" id="beteiligung_person" name="beteiligung" placeholder="Enter person involvement" required>
        </div>

        <!-- Wirkung auf Umgebung -->
        <div class="mb-3">
          <label for="wirkung_umgebung" class="form-label">Wirkung auf Umgebung</label>
          <textarea class="form-control" id="wirkung_umgebung" name="wirkung" rows="3" placeholder="Enter effect on environment" required></textarea>
        </div>

        <!-- Ger√§usche -->
        <div class="mb-3">
          <label for="geraeusche" class="form-label">Ger√§usche</label>
          <input type="text" class="form-control" id="geraeusche" name="geraeusche" placeholder="Enter sounds/noises" required>
        </div>

    <!-- Audio Upload 
        <div class="mb-3">
          <label for="audio_upload" class="form-label">Audio Upload</label>
          <input type="hidden" class="form-control" id="audio_upload" name="audio_upload" accept="audio/*">
        </div> -->

 <!-- Add image upload section -->
  <div>
    <label for="imageFile">Upload Image:</label>
    <input type="file" id="imageFile" accept="image/*">
    <div id="uploadStatus"></div>
    <img id="imagePreview" style="max-width: 200px; display: none;">
  </div>
  
  <!-- Hidden field to store the uploaded image URL -->
  <input type="hidden" id="imageUrl" name="imageUrl" value="">

      <button type="button" id="dynamic_btn" class="btn btn-success mt-3">Submit</button>
    </form>
  </div>
  </div>
  </body>  
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script> 
  <script src="js/nav.js"></script>
 <script>
        const getLocationBtn = document.getElementById('getLocationBtn');
        const gpsStatus = document.getElementById('gpsStatus');
        const latInput = document.getElementById('latitude');
        const lngInput = document.getElementById('longitude');

        getLocationBtn.addEventListener('click', function() {
            if (!navigator.geolocation) {
                showStatus('error', '‚úó Geolocation wird von diesem Browser nicht unterst√ºtzt.');
                return;
            }

            showStatus('loading', '‚è≥ Standort wird ermittelt...');
            getLocationBtn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    latInput.value = lat;
                    lngInput.value = lng;

                    showStatus('success', `‚úì Standort erfasst: ${lat.toFixed(4)}, ${lng.toFixed(4)}`);
                    
                    // Form URL mit vorausgef√ºllten Koordinaten aktualisieren
                    updateFormWithCoordinates(lat, lng);
                    
                    getLocationBtn.textContent = '‚úì Standort erfasst';
                    getLocationBtn.classList.remove('btn-primary');
                    getLocationBtn.classList.add('btn-success');
                },
                function(error) {
                    let errorMsg = '‚úó Standort konnte nicht ermittelt werden. ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMsg += 'Berechtigung verweigert. Bitte erlaube den Standortzugriff in deinen Browser-Einstellungen.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMsg += 'Standortinformationen nicht verf√ºgbar.';
                            break;
                        case error.TIMEOUT:
                            errorMsg += 'Zeit√ºberschreitung bei der Standortabfrage.';
                            break;
                        default:
                            errorMsg += 'Unbekannter Fehler.';
                    }
                    showStatus('error', errorMsg);
                    getLocationBtn.disabled = false;
                    console.error('Geolocation error:', error.code, error.message);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        });

        function showStatus(type, message) {
            gpsStatus.style.display = 'block';
            gpsStatus.className = 'gps-status';
            
            if (type === 'loading') {
                gpsStatus.classList.add('gps-loading');
            } else if (type === 'success') {
                gpsStatus.classList.add('gps-success');
            } else if (type === 'error') {
                gpsStatus.classList.add('gps-error');
            }
            
            gpsStatus.textContent = message;
        }

        function updateFormWithCoordinates(lat, lng) {
            // Update the local latitude and longitude input fields
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lng;
        }

        // Optional: Standort automatisch beim Laden erfassen
        // window.onload = function() {
        //     getLocationBtn.click();
        // };
    </script>
<script>
  // Handle image upload when file is selected
  document.getElementById('imageFile').addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    // Show loading status
    document.getElementById('uploadStatus').textContent = 'Uploading...';
    
    // Read file as base64
    const reader = new FileReader();
    reader.onload = async function(event) {
      const base64Data = event.target.result.split(',')[1];
      const fileName = file.name;
      const mimeType = file.type;
      
      try {
        // Upload via your web app endpoint
        const uploadData = new FormData();
        uploadData.append('action', 'upload');
        uploadData.append('base64Data', base64Data);
        uploadData.append('fileName', fileName);
        uploadData.append('mimeType', mimeType);
        
        const response = await fetch(
          "https://script.google.com/macros/s/AKfycbzvRBdwuCDoQ2ZBvqYwqGvyC4iGiv9UF1yeUqNF1YN5RqCLu-BcAIT1S_gdIygc02OhqQ/exec",
          {
            method: "POST",
            body: uploadData
          }
        );
        
        const result = await response.json();
        
        if (result.imageUrl) {
          // Store URL in hidden field
          document.getElementById('imageUrl').value = result.imageUrl;
          document.getElementById('uploadStatus').textContent = 'Upload successful!';
          
          // Optional: Show preview
          document.getElementById('imagePreview').src = result.imageUrl;
          document.getElementById('imagePreview').style.display = 'block';
        } else {
          throw new Error('No URL returned');
        }
        
      } catch (error) {
        document.getElementById('uploadStatus').textContent = 'Upload failed: ' + error;
      }
    };
    
    reader.readAsDataURL(file);
  });
</script>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="js/myLeaflteForm.js"></script>
  <script src="js/submit.js"></script>
   </body>
</html>